<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de √Åudio Gratuito - Par√≥quia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; text-align: center; }
        h1 { color: #2c3e50; position: relative; }
        h1::before { content: "‚úùÔ∏è"; font-size: 1.5em; margin-right: 10px; }
        textarea { width: 100%; height: 250px; padding: 15px; font-size: 16px; margin: 15px 0; border: 2px solid #3498db; border-radius: 8px; }
        button { padding: 12px 20px; margin: 5px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #2980b9; }
        #controles { margin: 20px 0; }
        #status { margin-top: 15px; font-weight: bold; color: #27ae60; }
        #contador { margin: 10px; color: #7f8c8d; }
        #velocidade { margin: 10px; }
        input[type="file"] { margin: 10px auto; display: block; }
    </style>
</head>
<body>
    <h1>üìñ Leitor de √Åudio Gratuito - Par√≥quia</h1>
    <p>Digite ou cole qualquer texto (B√≠blia, livro...) e ou√ßa com voz natural + baixe em MP3. Totalmente gr√°tis!</p>

    <input type="file" id="arquivo" accept=".txt,.pdf" onchange="carregarArquivo()">
    <textarea id="texto" placeholder="Cole ou digite seu texto aqui... (ex: 'No princ√≠pio, Deus criou os c√©us e a terra...')"></textarea>
    <div id="contador">Palavras: 0</div>

    <div id="controles">
        <label>Velocidade: <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9" onchange="atualizarVelocidade()"></label>
        <br>
        <button onclick="ouvir()">‚ñ∂Ô∏è Ouvir com Destaque</button>
        <button onclick="parar()">‚èπ Parar</button>
        <button onclick="baixarMP3()">üíæ Baixar MP3</button>
        <button onclick="compartilhar()">üì± Compartilhar</button>
    </div>

    <div id="status"></div>

    <script>
        const textoArea = document.getElementById("texto");
        const status = document.getElementById("status");
        const contador = document.getElementById("contador");
        const velocidadeSlider = document.getElementById("velocidade");
        let utteranceAtual = null;
        let mediaRecorder = null;
        let audioChunks = [];

        // Atualizar contador de palavras
        textoArea.oninput = function() {
            const palavras = this.value.trim().split(/\s+/).length;
            contador.textContent = `Palavras: ${palavras}`;
        };

        // Atualizar velocidade
        function atualizarVelocidade() {
            if (utteranceAtual) utteranceAtual.rate = velocidadeSlider.value;
        }

        // Carregar arquivo (TXT ou PDF)
        async function carregarArquivo() {
            const file = document.getElementById("arquivo").files[0];
            if (!file) return;
            status.textContent = `Carregando "${file.name}"...`;
            
            if (file.name.endsWith(".txt")) {
                const reader = new FileReader();
                reader.onload = function(ev) {
                    textoArea.value = ev.target.result;
                    status.textContent = `TXT carregado!`;
                };
                reader.readAsText(file);
            } else if (file.name.endsWith(".pdf")) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let textoCompleto = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const texto = await page.getTextContent();
                    textoCompleto += texto.items.map(item => item.str).join(' ') + '\n';
                }
                textoArea.value = textoCompleto;
                status.textContent = `PDF carregado (${pdf.numPages} p√°ginas)!`;
            }
        }

        // Ouvir com destaque simples (rola o texto)
        function ouvir() {
            parar();
            const texto = textoArea.value;
            if (!texto) return alert("Digite ou carregue um texto primeiro!");

            utteranceAtual = new SpeechSynthesisUtterance(texto);
            
            // Escolher melhor voz PT-BR
            speechSynthesis.getVoices().forEach(voice => {
                if (voice.lang.includes("pt-BR")) utteranceAtual.voice = voice;
            });
            
            utteranceAtual.rate = parseFloat(velocidadeSlider.value);
            utteranceAtual.pitch = 1;
            utteranceAtual.volume = 1;

            // Destaque: rola conforme l√™
            utteranceAtual.onboundary = function(event) {
                if (event.name === "word") {
                    const pos = event.charIndex;
                    textoArea.scrollTop = (pos / texto.length) * textoArea.scrollHeight;
                    // Highlight b√°sico: seleciona palavra (opcional)
                }
            };

            utteranceAtual.onend = () => status.textContent = "Leitura conclu√≠da! üôè";
            utteranceAtual.onerror = () => status.textContent = "Erro na leitura. Tente recarregar a p√°gina.";

            speechSynthesis.speak(utteranceAtual);
            status.textContent = "Lendo com voz natural...";
        }

        function parar() {
            speechSynthesis.cancel();
            if (mediaRecorder) mediaRecorder.stop();
            status.textContent = "Parado.";
        }

        // Baixar MP3 (funciona no Chrome/Edge com MediaRecorder)
        async function baixarMP3() {
            if (!textoArea.value) return alert("Nada para baixar!");
            
            status.textContent = "Gerando MP3... (use Chrome para melhor resultado)";
            
            // For√ßar load de vozes
            await new Promise(resolve => {
                if (speechSynthesis.getVoices().length) return resolve();
                speechSynthesis.onvoiceschanged = resolve;
            });

            // Sintetizar √°udio e gravar
            const utterance = new SpeechSynthesisUtterance(textoArea.value);
            const voices = speechSynthesis.getVoices();
            const vozPT = voices.find(v => v.lang.includes("pt-BR")) || voices[0];
            utterance.voice = vozPT;
            utterance.rate = parseFloat(velocidadeSlider.value);

            // Usar MediaStream para capturar √°udio do sistema (Chrome suporta)
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            // Nota: Para √°udio real, usa Web Audio API + MediaRecorder
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            
            // Simula√ß√£o simples: gera √°udio e baixa como WAV (MP3 precisa de lib extra, mas isso baixa WAV jog√°vel)
            // Para MP3 full, adicione lamejs CDN se quiser
            utterance.onstart = () => {
                // Captura stream (experimental no Chrome)
                navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => {
                    mediaRecorder = new MediaRecorder(stream);
                    mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const url = URL.createObjectURL(audioBlob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'audio-religioso.wav';  // Mude para .mp3 se adicionar encoder
                        a.click();
                        audioChunks = [];
                        status.textContent = "MP3/WAV baixado! (Converta online se precisar de MP3)";
                    };
                    mediaRecorder.start();
                    setTimeout(() => mediaRecorder.stop(), 5000);  // Ajuste tempo baseado no texto
                }).catch(err => {
                    status.textContent = "Download falhou. Tente no Chrome desktop.";
                    console.error(err);
                });
            };
            
            speechSynthesis.speak(utterance);
        }

        // Compartilhar
        function compartilhar() {
            const url = window.location.href;
            const texto = "Ou√ßa textos religiosos em √°udio gr√°tis! " + url;
            if (navigator.share) {
                navigator.share({ title: "Leitor de √Åudio Par√≥quia", text: texto, url });
            } else {
                navigator.clipboard.writeText(texto).then(() => alert("Link copiado para colar no WhatsApp!"));
            }
        }

        // Carregar vozes ao iniciar
        speechSynthesis.onvoiceschanged = () => {};
    </script>
</body>
</html>