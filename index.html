<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bíblia Ave Maria Paróquia</title>
    <link rel="icon" href="https://i.ibb.co/3hXvJ3k/favicon.ico">
    <style>
        body{font-family:Arial;max-width:900px;margin:20px auto;padding:20px;background:#f9f9f9;text-align:center}
        h1::before{content:"✝️ ";font-size:2em}
        select,button{padding:10px 16px;margin:5px;font-size:16px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer}
        select{width:280px}
        #textoContainer{border:2px solid #3498db;border-radius:10px;height:380px;overflow-y:auto;padding:15px;background:white;text-align:left;font-size:18px;line-height:1.8}
        textarea{width:100%;height:100%;border:none;outline:none;resize:none;background:transparent;font-size:18px;line-height:1.8}
        textarea::selection{background:#fffacd}
        #status{margin:15px;font-weight:bold;color:#27ae60}
        #progressContainer{display:none;margin:15px;background:#f0f0f0;padding:10px;border-radius:8px}
        #progressBar{width:100%;height:25px;background:#ddd;border-radius:12px;overflow:hidden}
        #progress{width:0%;height:100%;background:#27ae60;transition:width .3s}
    </style>
</head>
<body>
    <h1>Bíblia Ave Maria Paróquia</h1>
    <p>Escolha livro → capítulo → selecione trecho → ouça ou baixe áudio!</p>

    <select id="livro"><option>Carregando livros...</option></select>
    <select id="capitulo"><option>Carregando capítulos...</option></select><br><br>

    <select id="vozSelect"></select>
    <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9">
    <span id="velValue">0.9x</span><br><br>

    <div id="textoContainer"><textarea id="texto">Carregando Bíblia...</textarea></div>

    <div id="progressContainer">
        <div>Gerando áudio em silêncio: <span id="progressText">0%</span></div>
        <div id="progressBar"><div id="progress"></div></div>
    </div>

    <div>
        <button onclick="ouvir()">Ouvir selecionado</button>
        <button onclick="parar()">Parar</button>
        <button onclick="baixarAudio()">Baixar Áudio (ilimitado)</button>
        <button onclick="compartilhar()">Compartilhar</button>
    </div>

    <div id="status">Carregando Bíblia Ave Maria...</div>

    <script>
        const texto = document.getElementById("texto");
        const livroSelect = document.getElementById("livro");
        const capSelect = document.getElementById("capitulo");
        const status = document.getElementById("status");
        let savedStart = 0, savedEnd = 0;
        let voices = [];

        // Salvar seleção
        texto.addEventListener("mouseup", () => { savedStart = texto.selectionStart; savedEnd = texto.selectionEnd; });
        texto.addEventListener("keyup", () => { savedStart = texto.selectionStart; savedEnd = texto.selectionEnd; });

        // Carrega a Bíblia Ave Maria completa do fidalgobr (funciona 100%)
        fetch("biblia.json")
            .then(r => r.json())
            .then(data => {
                const livros = data.livros; // estrutura do fidalgobr: { "livros": { "Gênesis": { "1": { ... } } } }

                Object.keys(livros).sort().forEach(livro => {
                    livroSelect.add(new Option(livro, livro));
                });

                livroSelect.onchange = () => {
                    capSelect.innerHTML = "";
                    const capitulos = Object.keys(livros[livroSelect.value]);
                    capitulos.forEach(cap => capSelect.add(new Option(cap, cap)));
                    capSelect.onchange();
                };

                capSelect.onchange = () => {
                    const livro = livroSelect.value;
                    const cap = capSelect.value;
                    const capitulo = livros[livro][cap];
                    let txt = "";
                    Object.keys(capitulo).sort((a,b)=>Number(a)-Number(b)).forEach(v => {
                        txt += v + " " + capitulo[v] + "\n";
                    });
                    texto.value = txt.trim();
                    status.textContent = `${livro} ${cap} carregado!`;
                };

                // Inicia com Gênesis 1
                livroSelect.value = "Gênesis";
                livroSelect.onchange();
                status.textContent = "Bíblia Ave Maria completa carregada!";
            })
            .catch(err => {
                status.textContent = "Erro ao carregar biblia.json – verifique o arquivo.";
                console.error(err);
            });

        // Vozes PT-BR
        function loadVoices(){
            voices = speechSynthesis.getVoices().filter(v=>v.lang==="pt-BR");
            const vs = document.getElementById("vozSelect");
            vs.innerHTML = "";
            if(voices.length===0) vs.innerHTML = "<option>Use Chrome</option>";
            else voices.forEach((v,i)=>vs.add(new Option(v.name,i)));
        }
        speechSynthesis.onvoiceschanged = loadVoices;
        if(speechSynthesis.getVoices().length) loadVoices();

        function ouvir(){
            speechSynthesis.cancel();
            let t = texto.value.substring(savedStart,savedEnd).trim() || texto.value.trim();
            if(!t) return;
            const u = new SpeechSynthesisUtterance(t);
            u.voice = voices[document.getElementById("vozSelect").selectedIndex]||voices[0];
            u.rate = parseFloat(document.getElementById("velocidade").value);
            speechSynthesis.speak(u);
        }

        function parar(){ speechSynthesis.cancel(); }

        function baixarAudio(){
            let t = texto.value.substring(savedStart,savedEnd).trim() || texto.value.trim();
            if(!t) return alert("Selecione um trecho!");
            const u = new SpeechSynthesisUtterance(t);
            u.voice = voices[document.getElementById("vozSelect").selectedIndex]||voices[0];
            u.rate = parseFloat(document.getElementById("velocidade").value);
            u.volume = 0;
            const ctx = new OfflineAudioContext(1,48000,24000);
            const osc = ctx.createOscillator(); osc.frequency.value=0;
            const gain = ctx.createGain(); gain.gain.value=0;
            osc.connect(gain); gain.connect(ctx.destination); osc.start(0);
            u.onend = () => ctx.startRendering().then(buffer => {
                const blob = new Blob([bufferToWave(buffer)], {type:'audio/wav'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = "biblia.wav"; a.click();
                URL.revokeObjectURL(url);
                status.textContent = "Áudio baixado!";
            });
            speechSynthesis.speak(u);
        }

        function bufferToWave(abuffer){
            let numOfChan=abuffer.numberOfChannels,length=abuffer.length*numOfChan*2+44,
                buffer=new ArrayBuffer(length),view=new DataView(buffer),pos=0;
            const s16=d=>{view.setUint16(pos,d,true);pos+=2;};
            const s32=d=>{view.setUint32(pos,d,true);pos+=4;};
            s32(0x46464952);s32(length-8);s32(0x45564157);s32(0x20746d66);
            s16(16);s16(1);s16(numOfChan);s32(abuffer.sampleRate);
            s32(abuffer.sampleRate*2*numOfChan);s16(numOfChan*2);s16(16);
            s32(0x61746164);s32(length-pos-4);
            for(let i=0;i<abuffer.length;i++)for(let c=0;c<numOfChan;c++){
                let s=Math.max(-1,Math.min(1,abuffer.getChannelData(c)[i]));
                view.setInt16(pos,s<0?s*0x8000:s*0x7FFF,true);pos+=2;
            }
            return buffer;
        }

        function compartilhar(){
            navigator.clipboard.writeText("Bíblia Ave Maria completa → https://magoja-br.github.io/tts-para-todos");
            status.textContent = "Link copiado!";
        }
    </script>
</body>
</html>