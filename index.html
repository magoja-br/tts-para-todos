<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor B√≠blico Par√≥quia - Definitivo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; text-align: center; }
        h1 { color: #2c3e50; }
        h1::before { content: "‚úùÔ∏è "; font-size: 2em; }
        #textoContainer { 
            border: 2px solid #3498db; 
            border-radius: 10px; 
            height: 340px; 
            overflow-y: auto; 
            padding: 15px; 
            background: white; 
            text-align: left; 
            font-size: 18px; 
            line-height: 1.8; 
            margin: 15px 0;
        }
        #texto { width: 100%; height: 100%; outline: none; border: none; resize: none; font-family: Arial; font-size: 18px; line-height: 1.8; background: transparent; }
        #texto::selection { background: #fffacd; } /* Amarelo claro autom√°tico */
        button, select { padding: 12px 20px; margin: 8px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { background: #2980b9; }
        #status { margin: 15px; font-weight: bold; color: #27ae60; }
        #progressContainer { display: none; margin: 10px; }
        #progressBar { width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; }
        #progress { width: 0%; height: 100%; background: #27ae60; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>Leitor B√≠blico Par√≥quia</h1>
    <p>Selecione qualquer trecho (fica amarelo claro) ‚Üí s√≥ ele √© lido<br>Gere MP3 ilimitado em sil√™ncio com progresso (qualquer tamanho, sem erros)!</p>

    <input type="file" id="arquivo" accept=".txt,.pdf"><br><br>

    <select id="vozSelect">
        <option>Carregando vozes PT-BR...</option>
    </select>
    <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9">
    <span id="velValue">0.9x</span><br><br>

    <div id="textoContainer">
        <textarea id="texto" placeholder="Cole ou carregue um texto aqui...&#10;&#10;Exemplo: No princ√≠pio, Deus criou os c√©us e a terra.">No princ√≠pio, Deus criou os c√©us e a terra.</textarea>
    </div>

    <div id="progressContainer">
        <div>Gerando √°udio em sil√™ncio: <span id="progressText">0%</span></div>
        <div id="progressBar"><div id="progress"></div></div>
    </div>

    <div>
        <button onclick="ouvir()">‚ñ∂Ô∏è Ouvir s√≥ selecionado</button>
        <button onclick="parar()">‚èπ Parar</button>
        <button onclick="gerarMP3()">üíæ Gerar e Baixar √Åudio</button>
        <button onclick="compartilhar()">üì± Compartilhar</button>
    </div>

    <div id="status">Carregando vozes PT-BR...</div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const textoArea = document.getElementById("texto");
        const status = document.getElementById("status");
        const vozSelect = document.getElementById("vozSelect");
        const velocidade = document.getElementById("velocidade");
        const velValue = document.getElementById("velValue");
        const progressContainer = document.getElementById("progressContainer");
        const progress = document.getElementById("progress");
        const progressText = document.getElementById("progressText");
        let voices = [];
        let savedStart = 0;
        let savedEnd = 0;
        let audioChunks = [];

        velocidade.oninput = () => velValue.textContent = velocidade.value + "x";

        // Salva sele√ß√£o em tempo real
        textoArea.addEventListener("mouseup", () => { savedStart = textoArea.selectionStart; savedEnd = textoArea.selectionEnd; });
        textoArea.addEventListener("keyup", () => { savedStart = textoArea.selectionStart; savedEnd = textoArea.selectionEnd; });

        // === VOZES S√ì PT-BR ===
        function carregarVozes() {
            voices = speechSynthesis.getVoices().filter(v => v.lang === "pt-BR");
            vozSelect.innerHTML = "";
            if (voices.length === 0) {
                vozSelect.innerHTML = '<option>Sem vozes PT-BR (use Chrome)</option>';
                status.textContent = "Use Chrome ou instale vozes PT-BR.";
                return;
            }
            voices.forEach((v, i) => {
                const opt = new Option(v.name, i);
                if (i === 0) opt.selected = true;
                vozSelect.add(opt);
            });
            status.textContent = `Pronto! ${voices.length} vozes PT-BR. Selecione um trecho.`;
        }
        if (speechSynthesis.getVoices().length) carregarVozes();
        else speechSynthesis.onvoiceschanged = carregarVozes;

        // Upload
        document.getElementById("arquivo").onchange = async function() {
            const file = this.files[0];
            if (!file) return;
            status.textContent = "Carregando...";
            try {
                if (file.name.endsWith(".txt")) {
                    textoArea.value = await file.text();
                } else if (file.name.endsWith(".pdf")) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                    let texto = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        texto += content.items.map(t => t.str).join(" ") + "\n\n";
                    }
                    textoArea.value = texto;
                }
                status.textContent = "Arquivo carregado! Selecione o trecho.";
            } catch (e) {
                status.textContent = "Erro no arquivo. Cole o texto manualmente.";
                alert("Erro: " + e.message);
            }
        };

        // === OUVIR S√ì O SELECIONADO ===
        function ouvir() {
            parar();
            let texto = textoArea.value.substring(savedStart, savedEnd).trim();
            if (!texto) texto = textoArea.value.trim();
            if (!texto) return alert("Selecione um trecho ou digite um texto!");
            const u = new SpeechSynthesisUtterance(texto);
            u.voice = voices[vozSelect.selectedIndex] || voices[0];
            u.rate = parseFloat(velocidade.value);
            u.volume = 1;
            u.onend = () => status.textContent = "Leitura conclu√≠da";
            speechSynthesis.speak(u);
            status.textContent = `Lendo s√≥ o selecionado (${texto.split(" ").length} palavras)`;
        }

        function parar() { 
            speechSynthesis.cancel(); 
            status.textContent = "Parado."; 
        }

        // === GERAR √ÅUDIO ILIMITADO EM SIL√äNCIO (CLIENT-SIDE, SEM CORS) ===
        async function gerarMP3() {
            let texto = textoArea.value.substring(savedStart, savedEnd).trim();
            if (!texto) texto = textoArea.value.trim();
            if (!texto) return alert("Selecione um trecho!");
            progressContainer.style.display = 'block';
            updateProgress(0, "Iniciando s√≠ntese...");

            // Divide em chunks de 200 chars (limite Web Speech)
            const chunks = texto.match(/.{1,200}/g) || [texto];
            audioChunks = [];
            let chunkIndex = 0;

            // MimeType suportado
            const mimeType = MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : 'audio/mp4';
            const stream = new MediaStream();
            const mediaRecorder = new MediaRecorder(stream, { mimeType });
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
                const blob = new Blob(audioChunks, { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url;
                a.download = "biblia-paroquia.webm"; // Toca como MP3; renomeie para .mp3 se quiser
                a.click();
                URL.revokeObjectURL(url);
                progressContainer.style.display = 'none';
                status.textContent = "√Åudio baixado! (converta para MP3 online se precisar)";
            };
            mediaRecorder.start();

            function processarChunk() {
                if (chunkIndex >= chunks.length) {
                    mediaRecorder.stop();
                    return;
                }
                updateProgress((chunkIndex / chunks.length) * 100, `${chunkIndex + 1}/${chunks.length} chunks`);
                const chunkU = new SpeechSynthesisUtterance(chunks[chunkIndex]);
                chunkU.voice = voices[vozSelect.selectedIndex] || voices[0];
                chunkU.rate = parseFloat(velocidade.value);
                chunkU.volume = 0; // Sil√™ncio
                chunkU.onend = () => {
                    chunkIndex++;
                    setTimeout(processarChunk, 50); // Pausa entre chunks
                };
                speechSynthesis.speak(chunkU);
            }
            processarChunk();
        }

        function updateProgress(percent, text) {
            progress.style.width = percent + "%";
            progressText.textContent = text;
        }

        function compartilhar() {
            const msg = "Ou√ßa a B√≠blia selecionando trechos e baixando √°udio ilimitado ‚Üí https://magoja-br.github.io/tts-para-todos";
            if (navigator.share) navigator.share({title: "Leitor B√≠blico", text: msg});
            else { navigator.clipboard.writeText(msg); status.textContent = "Link copiado!"; }
        }
    </script>
</body>
</html>