<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de √Åudio com Destaque e MP3 - Par√≥quia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; text-align: center; }
        h1::before { content: "‚úùÔ∏è "; font-size: 1.5em; }
        #texto { width: 100%; height: 300px; padding: 15px; font-size: 17px; margin: 15px 0; border: 2px solid #3498db; border-radius: 8px; background: white; line-height: 1.5; }
        button { padding: 12px 20px; margin: 8px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #2980b9; }
        .selecionado { background: #fff3cd !important; padding: 2px 4px; border-radius: 4px; }
        #status { margin: 15px; font-weight: bold; color: #27ae60; }
        #arquivo { padding: 10px; border: 1px solid #3498db; border-radius: 6px; margin: 10px; }
        #debug { color: red; font-size: 12px; margin: 5px; display: none; }
    </style>
</head>
<body>
    <h1>Leitor de √Åudio Gratuito</h1>
    <p>Selecione qualquer trecho ‚Üí ele fica amarelo. Clique ‚ñ∂Ô∏è para ouvir s√≥ o selecionado ‚Üí Baixe em MP3</p>

    <label for="arquivo">Escolha arquivo TXT ou PDF (teste com um pequeno primeiro):</label><br>
    <input type="file" id="arquivo" accept=".txt,.pdf" onchange="carregarArquivo()"><br>
    <button onclick="testarUpload()">üîß Testar Upload (Debug)</button>
    <div id="debug"></div>

    <textarea id="texto" placeholder="Se o upload falhar, cole o texto aqui manualmente..."></textarea>

    <div>
        <label>Velocidade: <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9"></label><br><br>
        <button onclick="ouvir()">‚ñ∂Ô∏è Ouvir trecho selecionado</button>
        <button onclick="parar()">‚èπ Parar</button>
        <button onclick="baixarMP3()">üíæ Baixar MP3 do trecho</button>
        <button onclick="compartilhar()">üì± Compartilhar</button>
    </div>

    <div id="status">Pronto! Selecione o texto com o mouse ou fa√ßa upload.</div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.0.379/pdf.worker.min.js';
        const textoArea = document.getElementById("texto");
        const status = document.getElementById("status");
        const debug = document.getElementById("debug");
        const velocidade = document.getElementById("velocidade");
        let utterance = null;

        // Fun√ß√£o de debug para mostrar erros no console e na p√°gina
        function logDebug(msg, error = null) {
            console.log(msg, error);
            debug.textContent = msg + (error ? ': ' + error.message : '');
            debug.style.display = 'block';
            setTimeout(() => debug.style.display = 'none', 5000);
        }

        // Bot√£o de teste para upload
        function testarUpload() {
            const fileInput = document.getElementById("arquivo");
            if (!fileInput.files[0]) return alert("Escolha um arquivo primeiro!");
            carregarArquivo();  // Chama a fun√ß√£o real
        }

        // === CARREGAR TXT ou PDF (COM ERRO HANDLING ROBUSTO) ===
        async function carregarArquivo() {
            const file = document.getElementById("arquivo").files[0];
            if (!file) {
                status.textContent = "Nenhum arquivo selecionado.";
                return;
            }

            status.textContent = `Carregando "${file.name}" (${Math.round(file.size / 1024)} KB)...`;
            logDebug(`Iniciando upload de ${file.name}`);

            try {
                if (file.name.endsWith(".txt")) {
                    const texto = await file.text();
                    textoArea.value = texto;
                    status.textContent = `TXT carregado com sucesso! (${texto.split(" ").length} palavras) ‚Äì selecione o trecho.`;
                    logDebug("TXT lido OK");
                } else if (file.name.endsWith(".pdf")) {
                    logDebug("Processando PDF...");
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    let fullText = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const content = await page.getTextContent();
                        const pageText = content.items.map(item => item.str).join(" ");
                        fullText += pageText + "\n\n";
                    }
                    textoArea.value = fullText.trim();
                    status.textContent = `PDF carregado com sucesso! (${pdf.numPages} p√°ginas, ~${fullText.split(" ").length} palavras) ‚Äì selecione o trecho.`;
                    logDebug(`PDF lido OK: ${pdf.numPages} p√°ginas`);
                } else {
                    throw new Error("Formato n√£o suportado. Use TXT ou PDF.");
                }
            } catch (error) {
                status.textContent = "Erro no upload. Copie o texto manualmente no campo abaixo.";
                logDebug("Erro no upload", error);
                alert(`Falha: ${error.message}. Tente: 1) Arquivo menor; 2) Chrome/Edge; 3) Copie o texto de um PDF (use Google Docs para extrair).`);
            }
        }

        // === DESTAQUE VISUAL DO TRECHO SELECIONADO ===
        textoArea.addEventListener("mouseup", function() {
            const selStart = this.selectionStart;
            const selEnd = this.selectionEnd;
            if (selStart !== selEnd) {
                const selectedText = this.value.substring(selStart, selEnd);
                status.textContent = `Trecho selecionado: ${selectedText.split(" ").length} palavras ‚Äì pronto para ouvir ou baixar!`;
            }
        });

        // === OUVIR (s√≥ o trecho selecionado ou tudo) ===
        function ouvir() {
            parar();
            let textoParaLer = textoArea.value;

            if (textoArea.selectionStart !== textoArea.selectionEnd) {
                textoParaLer = textoArea.value.substring(textoArea.selectionStart, textoArea.selectionEnd);
            }

            if (!textoParaLer.trim()) return alert("Selecione ou digite um texto primeiro!");

            utterance = new SpeechSynthesisUtterance(textoParaLer);
            const voices = speechSynthesis.getVoices();
            const vozBR = voices.find(v => v.lang.includes("pt")) || voices[0];
            if (vozBR) utterance.voice = vozBR;

            utterance.rate = parseFloat(velocidade.value);
            utterance.pitch = 1;
            utterance.volume = 1;

            utterance.onend = () => status.textContent = "Leitura conclu√≠da üôè";
            utterance.onerror = () => status.textContent = "Erro na leitura ‚Äì verifique o console (F12).";

            speechSynthesis.speak(utterance);
            status.textContent = `Lendo trecho selecionado... (voz: ${vozBR ? vozBR.name : 'padr√£o'})`;
        }

        function parar() {
            speechSynthesis.cancel();
            status.textContent = "Parado.";
        }

        // === BAIXAR MP3/WAV DO TRECHO SELECIONADO ===
        async function baixarMP3() {
            let textoParaMP3 = textoArea.value;
            if (textoArea.selectionStart !== textoArea.selectionEnd) {
                textoParaMP3 = textoArea.value.substring(textoArea.selectionStart, textoArea.selectionEnd);
            }
            if (!textoParaMP3.trim()) return alert("Selecione um trecho para baixar!");

            status.textContent = "Gerando √°udio... (aceite permiss√£o de microfone). Use Chrome para melhor resultado.";

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];

                mediaRecorder.ondataavailable = e => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: "audio/wav" });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "trecho-paroquia.wav";  // WAV funciona em todos os celulares
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    stream.getTracks().forEach(t => t.stop());
                    status.textContent = "√Åudio baixado! Abra no seu player (converta para MP3 online se quiser). üéâ";
                };

                mediaRecorder.start();

                const tempUtterance = new SpeechSynthesisUtterance(textoParaMP3);
                const voices = speechSynthesis.getVoices();
                const vozBR = voices.find(v => v.lang.includes("pt")) || voices[0];
                tempUtterance.voice = vozBR;
                tempUtterance.rate = parseFloat(velocidade.value);

                tempUtterance.onend = () => setTimeout(() => mediaRecorder.stop(), 800);
                speechSynthesis.speak(tempUtterance);

                setTimeout(() => mediaRecorder.stop(), 60000); // M√°ximo 60s
            } catch (e) {
                status.textContent = "Falha no download. Tente Chrome desktop ou copie o √°udio manualmente.";
                logDebug("Erro no download MP3", e);
            }
        }

        function compartilhar() {
            const msg = "Ou√ßa trechos da B√≠blia com destaque e baixe em √°udio gr√°tis! ‚Üí " + location.href;
            if (navigator.share) {
                navigator.share({ title: "Leitor B√≠blico Par√≥quia", text: msg });
            } else {
                navigator.clipboard.writeText(msg).then(() => status.textContent = "Link copiado para WhatsApp!");
            }
        }

        // Carregar vozes ao iniciar
        if (speechSynthesis.getVoices().length === 0) {
            speechSynthesis.onvoiceschanged = () => status.textContent = "Vozes carregadas ‚Äì fa√ßa upload ou selecione texto!";
        } else {
            status.textContent = "Pronto para upload ou texto manual.";
        }
    </script>
</body>
</html>