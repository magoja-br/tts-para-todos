<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor de √Åudio Gratuito - Par√≥quia</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; text-align: center; }
        h1 { color: #2c3e50; position: relative; }
        h1::before { content: "‚úùÔ∏è"; font-size: 1.5em; margin-right: 10px; }
        textarea { width: 100%; height: 250px; padding: 15px; font-size: 16px; margin: 15px 0; border: 2px solid #3498db; border-radius: 8px; resize: vertical; }
        button { padding: 12px 20px; margin: 5px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; }
        button:hover { background: #2980b9; }
        button:disabled { background: #bdc3c7; cursor: not-allowed; }
        #controles { margin: 20px 0; }
        #status { margin-top: 15px; font-weight: bold; color: #27ae60; }
        #contador { margin: 10px; color: #7f8c8d; }
        #velocidade { margin: 10px; }
        input[type="file"] { margin: 10px auto; display: block; padding: 10px; border: 1px solid #3498db; border-radius: 6px; }
        #destaque { background: #e8f5e8; padding: 10px; border-radius: 6px; margin-top: 10px; white-space: pre-wrap; text-align: left; }
    </style>
</head>
<body>
    <h1>üìñ Leitor de √Åudio Gratuito - Par√≥quia</h1>
    <p>Digite ou cole qualquer texto (B√≠blia, livro...) e ou√ßa com voz natural + baixe em √°udio. Totalmente gr√°tis! Funciona melhor no Chrome/Edge.</p>

    <input type="file" id="arquivo" accept=".txt,.pdf" onchange="carregarArquivo()">
    <textarea id="texto" placeholder="Cole ou digite seu texto aqui... (ex: 'No princ√≠pio, Deus criou os c√©us e a terra...')"></textarea>
    <div id="contador">Palavras: 0</div>
    <div id="destaque"></div>

    <div id="controles">
        <label>Velocidade: <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9" onchange="atualizarVelocidade()"></label><br>
        <button onclick="ouvir()" id="btnOuvir">‚ñ∂Ô∏è Ouvir com Destaque</button>
        <button onclick="parar()">‚èπ Parar</button>
        <button onclick="baixarAudio()">üíæ Baixar √Åudio (WAV/MP3)</button>
        <button onclick="compartilhar()">üì± Compartilhar</button>
    </div>

    <div id="status"></div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const textoArea = document.getElementById("texto");
        const status = document.getElementById("status");
        const contador = document.getElementById("contador");
        const velocidadeSlider = document.getElementById("velocidade");
        const btnOuvir = document.getElementById("btnOuvir");
        const destaqueDiv = document.getElementById("destaque");
        let utteranceAtual = null;
        let audioChunks = [];

        // Contador de palavras
        textoArea.oninput = function() {
            const palavras = this.value.trim().split(/\s+/).length;
            contador.textContent = `Palavras: ${palavras}`;
        };

        function atualizarVelocidade() {
            if (utteranceAtual) utteranceAtual.rate = parseFloat(velocidadeSlider.value);
        }

        // Carregar arquivo
        async function carregarArquivo() {
            const file = document.getElementById("arquivo").files[0];
            if (!file) return;
            status.textContent = `Carregando "${file.name}"...`;
            try {
                if (file.name.endsWith(".txt")) {
                    const reader = new FileReader();
                    reader.onload = function(ev) {
                        textoArea.value = ev.target.result;
                        status.textContent = `TXT carregado! (${Math.round(file.size/1024)} KB)`;
                    };
                    reader.readAsText(file);
                } else if (file.name.endsWith(".pdf")) {
                    const arrayBuffer = await file.arrayBuffer();
                    const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
                    let textoCompleto = "";
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const texto = await page.getTextContent();
                        textoCompleto += texto.items.map(item => item.str).join(' ') + '\n\n';
                    }
                    textoArea.value = textoCompleto;
                    status.textContent = `PDF carregado (${pdf.numPages} p√°ginas)!`;
                }
            } catch (error) {
                status.textContent = `Erro ao carregar: ${error.message}. Tente TXT ou copie o texto manualmente.`;
                console.error(error);
            }
        }

        // Ouvir com destaque
        function ouvir() {
            parar();
            const texto = textoArea.value.trim();
            if (!texto) return alert("Digite ou carregue um texto primeiro!");

            // Mostrar texto no destaque
            destaqueDiv.innerHTML = texto.replace(/\n/g, '<br>');
            destaqueDiv.style.display = 'block';

            // Carregar vozes se necess√°rio
            if (speechSynthesis.getVoices().length === 0) {
                speechSynthesis.onvoiceschanged = () => speakNow(texto);
            } else {
                speakNow(texto);
            }

            function speakNow(texto) {
                utteranceAtual = new SpeechSynthesisUtterance(texto);
                const voices = speechSynthesis.getVoices();
                const vozPT = voices.find(v => v.lang.startsWith("pt")) || voices[0];
                if (vozPT) utteranceAtual.voice = vozPT;
                
                utteranceAtual.rate = parseFloat(velocidadeSlider.value);
                utteranceAtual.pitch = 1;
                utteranceAtual.volume = 1;

                // Destaque e rolagem
                let charIndex = 0;
                utteranceAtual.onboundary = function(event) {
                    if (event.name === 'word') {
                        charIndex = event.charIndex;
                        // Highlight simples: adiciona classe (estilo CSS pode expandir)
                        const range = document.createRange();
                        const sel = window.getSelection();
                        range.setStart(destaqueDiv.childNodes[0] || destaqueDiv, charIndex);
                        sel.removeAllRanges();
                        sel.addRange(range);
                        destaqueDiv.scrollTop = (charIndex / texto.length) * destaqueDiv.scrollHeight;
                    }
                };

                utteranceAtual.onend = () => {
                    status.textContent = "Leitura conclu√≠da! üôè";
                    btnOuvir.disabled = false;
                };
                utteranceAtual.onerror = (e) => {
                    status.textContent = `Erro na leitura: ${e.error}. Tente recarregar ou mudar voz.`;
                    console.error(e);
                    btnOuvir.disabled = false;
                };

                btnOuvir.disabled = true;
                speechSynthesis.speak(utteranceAtual);
                status.textContent = "Lendo com destaque... (voz: " + (vozPT ? vozPT.name : 'padr√£o') + ")";
            }
        }

        function parar() {
            speechSynthesis.cancel();
            btnOuvir.disabled = false;
            status.textContent = "Parado.";
            destaqueDiv.style.display = 'none';
        }

        // Baixar √Åudio (WAV simples; para MP3, usa blob b√°sico)
        async function baixarAudio() {
            const texto = textoArea.value.trim();
            if (!texto) return alert("Nada para baixar!");

            status.textContent = "Gerando √°udio... (pode demorar 10-30s no celular)";

            try {
                // Sintetizar e capturar com MediaRecorder (precisa permiss√£o de microfone para capturar sa√≠da de √°udio)
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                const mediaRecorder = new MediaRecorder(stream);
                const chunks = [];

                mediaRecorder.ondataavailable = (e) => chunks.push(e.data);
                mediaRecorder.onstop = () => {
                    const blob = new Blob(chunks, { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'audio-paroquia.wav';  // Mude para .mp3 se converter depois
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    stream.getTracks().forEach(track => track.stop());
                    status.textContent = "√Åudio baixado como WAV! Abra no player do celular.";
                };

                mediaRecorder.start();
                // Iniciar s√≠ntese
                const utterance = new SpeechSynthesisUtterance(texto);
                const voices = speechSynthesis.getVoices();
                utterance.voice = voices.find(v => v.lang.startsWith("pt")) || voices[0];
                utterance.rate = parseFloat(velocidadeSlider.value);
                speechSynthesis.speak(utterance);

                // Parar ap√≥s 5s ou onend (ajuste para texto longo)
                utterance.onend = () => setTimeout(() => mediaRecorder.stop(), 500);
                setTimeout(() => mediaRecorder.stop(), 10000);  // Fallback 10s

            } catch (error) {
                status.textContent = `Download falhou: ${error.message}. Tente no Chrome desktop ou use uma extens√£o TTS para MP3.`;
                console.error(error);
            }
        }

        // Compartilhar
        function compartilhar() {
            const url = window.location.href;
            const textoShare = "Ou√ßa textos da B√≠blia em √°udio gr√°tis! " + url;
            if (navigator.share) {
                navigator.share({ title: "Leitor √Åudio Par√≥quia", text: textoShare, url });
            } else {
                navigator.clipboard.writeText(textoShare).then(() => {
                    status.textContent = "Link copiado! Cole no WhatsApp.";
                }).catch(() => alert("Copie manualmente: " + textoShare));
            }
        }

        // Inicializar vozes
        window.onload = () => {
            if (speechSynthesis.getVoices().length > 0) {
                status.textContent = "Pronto! Vozes carregadas.";
            }
        };
    </script>
</body>
</html>