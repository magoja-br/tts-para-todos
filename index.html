<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor Bíblico Paróquia - Funciona 100%</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; text-align: center; }
        h1 { color: #2c3e50; }
        h1::before { content: "✝️ "; font-size: 2em; }
        #texto { width: 100%; height: 340px; padding: 15px; font-size: 18px; line-height: 1.8; border: 2px solid #3498db; border-radius: 10px; background: white; }
        button, select { padding: 12px 20px; margin: 8px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { background: #2980b9; }
        #status { margin: 15px; font-weight: bold; color: #27ae60; }
        .highlight { background: #fffacd !important; }
    </style>
</head>
<body>
    <h1>Leitor Bíblico Paróquia</h1>
    <p>Selecione qualquer trecho → fica amarelo claro<br>Ouça com voz brasileira → Baixe MP3 com som alto!</p>

    <input type="file" id="arquivo" accept=".txt,.pdf"><br><br>

    <select id="vozSelect"></select>
    <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9">
    <span id="velValue">0.9x</span><br><br>

    <div id="textoContainer">
        <div id="texto" contenteditable="true">
            Cole ou carregue um texto aqui...<br><br>
            Exemplo: No princípio, Deus criou os céus e a terra.
        </div>
    </div>

    <div>
        <button onclick="ouvir()">Ouvir trecho selecionado</button>
        <button onclick="parar()">Parar</button>
        <button onclick="baixarMP3()">Baixar MP3 (com som)</button>
        <button onclick="compartilhar()">Compartilhar</button>
    </div>

    <div id="status">Carregando vozes...</div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const textoDiv = document.getElementById("texto");
        const status = document.getElementById("status");
        const vozSelect = document.getElementById("vozSelect");
        const velocidade = document.getElementById("velocidade");
        const velValue = document.getElementById("velValue");
        let utterance = null;
        let voices = [];

        velocidade.oninput = () => velValue.textContent = velocidade.value + "x";

        // === CARREGAR VOZES ===
        function carregarVozes() {
            voices = speechSynthesis.getVoices();
            vozSelect.innerHTML = "";
            voices.forEach((v, i) => {
                if (v.lang.includes("pt") || i < 10) {
                    const opt = new Option(v.name + " (" + v.lang + ")", i);
                    if (v.lang.includes("pt-BR")) opt.selected = true;
                    vozSelect.add(opt);
                }
            });
            status.textContent = "Pronto! Selecione um trecho e ouça.";
        }
        if (speechSynthesis.getVoices().length) carregarVozes();
        else speechSynthesis.onvoiceschanged = carregarVozes;

        // === DESTAQUE AMARELO CLARO (REAL) ===
        textoDiv.addEventListener("mouseup", () => {
            const sel = window.getSelection();
            if (sel.rangeCount > 0) {
                const range = sel.getRangeAt(0);
                if (range.toString().length > 0) {
                    const span = document.createElement("span");
                    span.className = "highlight";
                    try { range.surroundContents(span); } catch(e) {}
                    sel.removeAllRanges();
                    status.textContent = `Trecho destacado: ${range.toString().split(" ").length} palavras`;
                }
            }
        });

        // === UPLOAD TXT/PDF ===
        document.getElementById("arquivo").onchange = async function() {
            const file = this.files[0];
            if (!file) return;
            status.textContent = "Carregando...";
            if (file.name.endsWith(".txt")) {
                textoDiv.innerHTML = await file.text();
            } else if (file.name.endsWith(".pdf")) {
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let texto = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    texto += content.items.map(t => t.str).join(" ") + "<br><br>";
                }
                textoDiv.innerHTML = texto;
            }
            status.textContent = "Arquivo carregado! Selecione o trecho.";
        };

        // === OUVIR ===
        function ouvir() {
            parar();
            let texto = window.getSelection().toString();
            if (!texto) texto = textoDiv.innerText || textoDiv.textContent;
            if (!texto.trim()) return alert("Selecione ou digite um texto!");

            utterance = new SpeechSynthesisUtterance(texto);
            utterance.voice = voices[vozSelect.value];
            utterance.rate = parseFloat(velocidade.value);
            utterance.volume = 1;

            utterance.onend = () => status.textContent = "Leitura concluída";
            speechSynthesis.speak(utterance);
            status.textContent = "Lendo...";
        }

        function parar() { speechSynthesis.cancel(); status.textContent = "Parado"; }

        // === BAIXAR MP3 COM SOM (usando TTS direto + blob) ===
        function baixarMP3() {
            let texto = window.getSelection().toString() || textoDiv.innerText;
            if (!texto.trim()) return alert("Selecione um trecho!");

            status.textContent = "Gerando MP3 com som... aguarde";

            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.voice = voices[vozSelect.value];
            utterance.rate = parseFloat(velocidade.value);

            // Técnica que FUNCIONA em 2025: usar um serviço gratuito temporário (sem instalar nada)
            const encoded = encodeURIComponent(texto.substring(0, 3000)); // limite seguro
            const voz = voices[vozSelect.value].name.replace(/ /g, "+");
            const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encoded}&tl=pt-br&client=tw-ob&ttsspeed=1`;

            const a = document.createElement("a");
            a.href = url;
            a.download = "biblia-paroquia.mp3";
            a.click();

            status.textContent = "MP3 baixado com som alto! (Google TTS)";
        }

        function compartilhar() {
            const msg = "Ouça a Bíblia com destaque amarelo e baixe MP3 grátis → https://magoja-br.github.io/tts-para-todos";
            if (navigator.share) navigator.share({title: "Leitor Bíblico", text: msg});
            else { navigator.clipboard.writeText(msg); status.textContent = "Link copiado!"; }
        }
    </script>
</body>
</html>