<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bíblia Ave Maria Paróquia</title>
    <style>
        body{font-family:Arial;max-width:900px;margin:20px auto;padding:20px;background:#f9f9f9;text-align:center}
        h1::before{content:"✝️ ";font-size:2em}
        select,button{padding:10px 16px;margin:5px;font-size:16px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer}
        select{width:280px}
        #textoContainer{border:2px solid #3498db;border-radius:10px;height:380px;overflow-y:auto;padding:15px;background:white;text-align:left;font-size:18px;line-height:1.8}
        textarea{width:100%;height:100%;border:none;outline:none;resize:none;background:transparent;font-size:18px;line-height:1.8}
        textarea::selection{background:#fffacd}
        #status{margin:15px;font-weight:bold;color:#27ae60}
    </style>
</head>
<body>
    <h1>Bíblia Ave Maria Paróquia</h1>
    <p>Escolha livro → capítulo → selecione trecho → ouça ou baixe áudio ilimitado!</p>

    <select id="livro"></select>
    <select id="capitulo"></select><br><br>

    <select id="vozSelect"></select>
    <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9">
    <span id="velValue">0.9x</span><br><br>

    <div id="textoContainer"><textarea id="texto">Carregando...</textarea></div>

    <div>
        <button onclick="ouvir()">Ouvir só selecionado</button>
        <button onclick="parar()">Parar</button>
        <button onclick="gerarAudio()">Baixar Áudio</button>
        <button onclick="compartilhar()">Compartilhar</button>
    </div>

    <div id="status">Carregando Bíblia...</div>

    <script src="biblia.js"></script>
    <script>
        const textoArea = document.getElementById("texto");
        const livroSelect = document.getElementById("livro");
        const capituloSelect = document.getElementById("capitulo");
        const status = document.getElementById("status");
        let savedStart = 0, savedEnd = 0;
        let voices = [];

        // Carrega a Bíblia do arquivo local
        const biblia = bibliaData.antigoTestamento; // seu arquivo tem tudo aqui

        biblia.forEach(livro => {
            livroSelect.add(new Option(livro.nome, livro.nome));
        });

        livroSelect.onchange = () => {
            capituloSelect.innerHTML = "";
            biblia.find(l => l.nome === livroSelect.value).capitulos.forEach(c => {
                capituloSelect.add(new Option(c.capitulo, c.capitulo));
            });
            capituloSelect.onchange();
        };

        capituloSelect.onchange = () => {
            const livro = biblia.find(l => l.nome === livroSelect.value);
            const cap = livro.capitulos.find(c => c.capitulo == capituloSelect.value);
            let texto = "";
            cap.versiculos.forEach(v => {
                texto += v.versiculo + " " + v.texto + "\n";
            });
            textoArea.value = texto.trim();
            status.textContent = `${livro.nome} ${cap.capitulo} carregado – selecione o trecho!`;
        };

        livroSelect.value = "Gênesis";
        livroSelect.onchange();

        // Salvar seleção
        textoArea.addEventListener("mouseup", salvar);
        textoArea.addEventListener("keyup", salvar);
        function salvar(){ savedStart = textoArea.selectionStart; savedEnd = textoArea.selectionEnd; }

        // Vozes PT-BR
        function carregarVozes(){
            voices = speechSynthesis.getVoices().filter(v=>v.lang==="pt-BR");
            const vs = document.getElementById("vozSelect");
            vs.innerHTML = "";
            if(voices.length===0){
                vs.innerHTML = "<option>Use Chrome</option>";
                return;
            }
            voices.forEach((v,i)=>vs.add(new Option(v.name,i)));
        }
        speechSynthesis.onvoiceschanged = carregarVozes;
        if(speechSynthesis.getVoices().length) carregarVozes();

        function ouvir(){
            parar();
            let txt = textoArea.value.substring(savedStart,savedEnd).trim() || textoArea.value.trim();
            if(!txt) return;
            const u = new SpeechSynthesisUtterance(txt);
            u.voice = voices[document.getElementById("vozSelect").selectedIndex]||voices[0];
            u.rate = parseFloat(document.getElementById("velocidade").value);
            speechSynthesis.speak(u);
        }

        function parar(){ speechSynthesis.cancel(); }

        function gerarAudio(){
            let txt = textoArea.value.substring(savedStart,savedEnd).trim() || textoArea.value.trim();
            if(!txt) return alert("Selecione um trecho!");
            const u = new SpeechSynthesisUtterance(txt);
            u.voice = voices[document.getElementById("vozSelect").selectedIndex]||voices[0];
            u.rate = parseFloat(document.getElementById("velocidade").value);
            u.volume = 0;
            const ctx = new OfflineAudioContext(1,48000,24000);
            const osc = ctx.createOscillator(); osc.frequency.value = 0;
            const gain = ctx.createGain(); gain.gain.value = 0;
            osc.connect(gain); gain.connect(ctx.destination); osc.start(0);
            u.onend = () => ctx.startRendering().then(buffer => {
                const blob = bufferToWave(buffer);
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a");
                a.href = url; a.download = "biblia.wav";
                a.click();
            });
            speechSynthesis.speak(u);
        }

        function bufferToWave(abuffer){
            // (mesmo código de antes – funciona)
            // ... cole o bufferToWave completo aqui (o mesmo da versão anterior)
        }

        function compartilhar(){
            navigator.clipboard.writeText("Bíblia Ave Maria completa → https://magoja-br.github.io/tts-para-todos");
            status.textContent = "Link copiado!";
        }
    </script>
</body>
</html>