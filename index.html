<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leitor B√≠blico Par√≥quia - FUNCIONA</title>
    <style>
        body { font-family: Arial; max-width: 900px; margin: 20px auto; padding: 20px; background: #f9f9f9; text-align: center; }
        h1::before { content: "‚úùÔ∏è "; font-size: 2em; }
        #textoContainer { border: 2px solid #3498db; border-radius: 10px; height: 380px; overflow-y: auto; padding: 15px; background: white; text-align: left; font-size: 18px; line-height: 1.8; margin: 15px 0; }
        textarea { width: 100%; height: 100%; border: none; outline: none; resize: none; font-size: 18px; line-height: 1.8; background: transparent; }
        textarea::selection { background: #fffacd; color: black; } /* Amarelo claro */
        button, select { padding: 12px 20px; margin: 8px; font-size: 16px; background: #3498db; color: white; border: none; border-radius: 8px; cursor: pointer; }
        button:hover { background: #2980b9; }
        #status { margin: 15px; font-weight: bold; color: #27ae60; }
        #progressContainer { display: none; margin: 15px; }
        #progressBar { width: 100%; height: 25px; background: #ddd; border-radius: 12px; overflow: hidden; }
        #progress { width: 0%; height: 100%; background: #27ae60; transition: width 0.3s; }
    </style>
</head>
<body>
    <h1>Leitor B√≠blico Par√≥quia</h1>
    <p>Selecione qualquer trecho ‚Üí fica amarelo claro e s√≥ ele √© lido<br>MP3 ilimitado (qualquer tamanho) com voz PT-BR perfeita da Microsoft</p>

    <input type="file" id="arquivo" accept=".txt,.pdf"><br><br>

    <select id="vozSelect"></select>
    <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="1">
    <span id="velValue">1.0x</span><br><br>

    <div id="textoContainer">
        <textarea id="texto" placeholder="Cole ou carregue o texto aqui...">No princ√≠pio, Deus criou os c√©us e a terra.</textarea>
    </div>

    <div id="progressContainer">
        <div>Gerando MP3: <span id="progressText">0%</span></div>
        <div id="progressBar"><div id="progress"></div></div>
    </div>

    <div>
        <button onclick="ouvir()">‚ñ∂Ô∏è Ouvir s√≥ o selecionado</button>
        <button onclick="parar()">‚èπ Parar</button>
        <button onclick="gerarMP3()">üíæ Baixar MP3 (ilimitado)</button>
        <button onclick="compartilhar()">üì± Compartilhar</button>
    </div>

    <div id="status">Carregando...</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const textoArea = document.getElementById("texto");
        const status = document.getElementById("status");
        const vozSelect = document.getElementById("vozSelect");
        const velocidade = document.getElementById("velocidade");
        const velValue = document.getElementById("velValue");
        const progressContainer = document.getElementById("progressContainer");
        const progress = document.getElementById("progress");
        const progressText = document.getElementById("progressText");
        let savedStart = 0;
        let savedEnd = 0;

        velocidade.oninput = () => velValue.textContent = velocidade.value + "x";

        // Salva a sele√ß√£o toda vez que o usu√°rio seleciona
        textoArea.addEventListener("mouseup", salvarSelecao);
        textoArea.addEventListener("keyup", salvarSelecao);
        textoArea.addEventListener("touchend", salvarSelecao);

        function salvarSelecao() {
            savedStart = textoArea.selectionStart;
            savedEnd = textoArea.selectionEnd;
        }

        // Carregar vozes PT-BR
        function carregarVozes() {
            const voices = speechSynthesis.getVoices().filter(v => v.lang === "pt-BR");
            vozSelect.innerHTML = "";
            if (voices.length === 0) {
                vozSelect.innerHTML = '<option>Chrome necess√°rio para vozes PT-BR</option>';
                return;
            }
            voices.forEach((v, i) => vozSelect.add(new Option(v.name, i)));
            status.textContent = "Pronto! Selecione o trecho desejado.";
        }
        speechSynthesis.onvoiceschanged = carregarVozes;
        if (speechSynthesis.getVoices().length) carregarVozes();

        // Upload
        document.getElementById("arquivo").onchange = async e => {
            const file = e.target.files[0];
            if (!file) return;
            status.textContent = "Carregando...";
            if (file.name.endsWith(".txt")) {
                textoArea.value = await file.text();
            } else if (file.name.endsWith(".pdf")) {
                const buf = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(buf).promise;
                let txt = "";
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    txt += content.items.map(item => item.str).join(" ") + "\n\n";
                }
                textoArea.value = txt;
            }
            status.textContent = "Arquivo carregado! Selecione o trecho.";
        };

        // Ouvir s√≥ o selecionado
        function ouvir() {
            parar();
            let texto = textoArea.value.substring(savedStart, savedEnd).trim();
            if (!texto) texto = textoArea.value.trim();
            if (!texto) return alert("Selecione um trecho!");
            const u = new SpeechSynthesisUtterance(texto);
            const voices = speechSynthesis.getVoices().filter(v => v.lang === "pt-BR");
            u.voice = voices[vozSelect.selectedIndex] || voices[0];
            u.rate = parseFloat(velocidade.value);
            u.onend = () => status.textContent = "Leitura conclu√≠da";
            speechSynthesis.speak(u);
            status.textContent = `Lendo s√≥ o trecho selecionado (${texto.split(" ").length} palavras)`;
        }

        function parar() { speechSynthesis.cancel(); status.textContent = "Parado"; }

        // MP3 ILIMITADO VIA EDGE TTS (MICROSOFT) ‚Äì VOZ PERFEITA PT-BR
        async function gerarMP3() {
            let texto = textoArea.value.substring(savedStart, savedEnd).trim() || textoArea.value.trim();
            if (!texto) return alert("Selecione ou digite texto!");
            progressContainer.style.display = "block";
            updateProgress(10, "Conectando ao Microsoft Edge TTS...");

            const voz = "pt-BR-AntonioNeural"; // Voz masculina perfeita (pode mudar para pt-BR-FranciscaNeural para feminina)

            const body = `<speak version='1.0' xml:lang='pt-BR'><voice name='${voz}'><prosody rate='${(velocidade.value-1)*100}%'>${texto.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</prosody></voice></speak>`;

            updateProgress(40, "Gerando √°udio...");

            const response = await fetch("https://speech.platform.bing.com/consumer/speech/synthesize/readaloud/v1?trustedclienttoken=6A5AA1D4EAFF4E9FB37E23D68491D6F4&SSML=" + encodeURIComponent(body), {
                method: "POST",
                headers: {
                    "Content-Type": "application/ssml+xml",
                    "User-Agent": "Mozilla/5.0"
                }
            });

            if (!response.ok) throw new Error("Falha na s√≠ntese");

            updateProgress(80, "Finalizando MP3...");

            const blob = await response.blob();
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "biblia-paroquia.mp3";
            a.click();
            URL.revokeObjectURL(url);

            updateProgress(100, "Conclu√≠do!");
            setTimeout(() => progressContainer.style.display = "none", 2000);
            status.textContent = "MP3 baixado com voz Microsoft PT-BR perfeita (ilimitado)!";
        }

        function updateProgress(p, txt) {
            progress.style.width = p + "%";
            progressText.textContent = txt;
        }

        function compartilhar() {
            const msg = "Ou√ßa qualquer trecho da B√≠blia em √°udio com voz perfeita ‚Üí https://magoja-br.github.io/tts-para-todos";
            if (navigator.share) navigator.share({title: "Leitor B√≠blico", text: msg});
            else { navigator.clipboard.writeText(msg); status.textContent = "Link copiado!"; }
        }
    </script>
</body>
</html>