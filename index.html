<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bíblia Ave Maria Paróquia</title>
    <link rel="icon" href="https://i.ibb.co/3hXvJ3k/favicon.ico" type="image/x-icon">
    <style>
        body{font-family:Arial;max-width:900px;margin:20px auto;padding:20px;background:#f9f9f9;text-align:center}
        h1::before{content:"✝️ ";font-size:2em}
        select,button{padding:10px 16px;margin:5px;font-size:16px;background:#3498db;color:white;border:none;border-radius:8px;cursor:pointer}
        select{width:280px}
        #textoContainer{border:2px solid #3498db;border-radius:10px;height:380px;overflow-y:auto;padding:15px;background:white;text-align:left;font-size:18px;line-height:1.8}
        textarea{width:100%;height:100%;border:none;outline:none;resize:none;background:transparent;font-size:18px;line-height:1.8}
        textarea::selection{background:#fffacd}
        #status{margin:15px;font-weight:bold;color:#27ae60}
        #progressContainer{display:none;margin:15px;background:#f0f0f0;padding:10px;border-radius:8px}
        #progressBar{width:100%;height:25px;background:#ddd;border-radius:12px;overflow:hidden}
        #progress{width:0%;height:100%;background:#27ae60;transition:width .3s}
    </style>
</head>
<body>
    <h1>Bíblia Ave Maria Paróquia</h1>
    <p>Escolha livro → capítulo → selecione trecho → ouça ou baixe áudio ilimitado!</p>

    <select id="livro"></select>
    <select id="capitulo"></select><br><br>

    <select id="vozSelect"></select>
    <input type="range" id="velocidade" min="0.5" max="2" step="0.1" value="0.9">
    <span id="velValue">0.9x</span><br><br>

    <div id="textoContainer"><textarea id="texto">Carregando Bíblia...</textarea></div>

    <div id="progressContainer">
        <div>Gerando áudio: <span id="progressText">0%</span></div>
        <div id="progressBar"><div id="progress"></div></div>
    </div>

    <div>
        <button onclick="ouvir()">Ouvir selecionado</button>
        <button onclick="parar()">Parar</button>
        <button onclick="gerarAudio()">Baixar Áudio</button>
        <button onclick="compartilhar()">Compartilhar</button>
    </div>

    <div id="status">Carregando...</div>

    <script src="biblia.js"></script>
    <script>
        const textoArea = document.getElementById("texto");
        const livroSelect = document.getElementById("livro");
        const capituloSelect = document.getElementById("capitulo");
        const status = document.getElementById("status");
        let savedStart = 0, savedEnd = 0;
        let voices = [];

        // Carrega TODOS os livros (Antigo + Novo Testamento)
        const todosLivros = bibliaData.antigoTestamento; // seu arquivo tem tudo aqui (inclui Novo Testamento)

        todosLivros.forEach(l => livroSelect.add(new Option(l.nome, l.nome)));

        livroSelect.onchange = () => {
            capituloSelect.innerHTML = "";
            const livro = todosLivros.find(l => l.nome === livroSelect.value);
            livro.capitulos.forEach(c => capituloSelect.add(new Option(c.capitulo, c.capitulo)));
            capituloSelect.onchange();
        };

        capituloSelect.onchange = () => {
            const livro = todosLivros.find(l => l.nome === livroSelect.value);
            const cap = livro.capitulos.find(c => c.capitulo == capituloSelect.value);
            let txt = "";
            cap.versiculos.forEach(v => txt += v.versiculo + " " + v.texto + "\n");
            texto.value = txt.trim();
            status.textContent = `${livro.nome} ${cap.capitulo} carregado!`;
        };

        livroSelect.value = "Gênesis";
        livroSelect.onchange();

        // Salvar seleção
        texto.addEventListener("mouseup", salvar);
        texto.addEventListener("keyup", salvar);
        function salvar(){ savedStart = texto.selectionStart; savedEnd = texto.selectionEnd; }

        // Vozes PT-BR
        function carregarVozes(){
            voices = speechSynthesis.getVoices().filter(v=>v.lang==="pt-BR");
            const vs = document.getElementById("vozSelect");
            vs.innerHTML = "";
            if(voices.length===0){
                vs.innerHTML = "<option>Chrome necessário</option>";
                return;
            }
            voices.forEach((v,i)=>vs.add(new Option(v.name,i)));
        }
        speechSynthesis.onvoiceschanged = carregarVozes;
        if(speechSynthesis.getVoices().length) carregarVozes();

        function ouvir(){
            parar();
            let txt = texto.value.substring(savedStart,savedEnd).trim() || texto.value.trim();
            if(!txt) return;
            const u = new SpeechSynthesisUtterance(txt);
            u.voice = voices[document.getElementById("vozSelect").selectedIndex]||voices[0];
            u.rate = parseFloat(document.getElementById("velocidade").value);
            speechSynthesis.speak(u);
        }

        function parar(){ speechSynthesis.cancel(); }

        // GERA ÁUDIO CORRIGIDO (sem erro de createObjectURL)
        async function gerarAudio(){
            let texto = texto.value.substring(savedStart,savedEnd).trim() || texto.value.trim();
            if(!texto) return alert("Selecione um trecho!");
            document.getElementById("progressContainer").style.display = "block";
            updateProgress(0,"Preparando...");

            const sampleRate = 24000;
            const chunks = texto.match(/.{1,150}[.!?,;]?/g) || [texto];
            const buffers = [];

            for(let i=0; i<chunks.length; i++){
                updateProgress((i/chunks.length)*90, `Processando ${i+1}/${chunks.length}`);
                const buffer = await sintetizarChunk(chunks[i]);
                if(buffer && buffer.length > 0) buffers.push(buffer);
            }

            if(buffers.length === 0){
                status.textContent = "Erro: buffer vazio. Tente texto menor.";
                return;
            }

            updateProgress(95,"Finalizando...");
            const totalLength = buffers.reduce((s,b)=>s+b.length,0);
            const finalBuffer = new AudioContext({sampleRate}).createBuffer(1,totalLength,sampleRate);
            let offset = 0;
            buffers.forEach(b=>{ 
                finalBuffer.copyToChannel(b.getChannelData(0),0,offset); 
                offset += b.length; 
            });

            const wavBlob = bufferToWave(finalBuffer);
            const url = URL.createObjectURL(wavBlob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "biblia.wav";
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById("progressContainer").style.display = "none";
            status.textContent = "Áudio baixado!";
        }

        // ... (mesmas funções sintetizarChunk e bufferToWave do código anterior)

        function compartilhar(){
            navigator.clipboard.writeText("Bíblia Ave Maria completa → https://magoja-br.github.io/tts-para-todos");
            status.textContent = "Link copiado!";
        }
    </script>
</body>
</html>